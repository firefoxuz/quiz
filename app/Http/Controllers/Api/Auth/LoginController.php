<?php

namespace App\Http\Controllers\Api\Auth;

use App\Http\Controllers\Api\BaseController;
use App\Services\FaceData;
use App\Traits\ApiResponser;
use Auth;
use Carbon\Carbon;
use Illuminate\Http\Request;

/**
 *
 * @OA\Schemas (
 *   @OA\Schema(
 *     schema="FaceData",
 *     type="object",
 *     example={
 *   {
 *       "status": "success",
 *       "message": "Retrieved successfully",
 *       "data": {
 *           {
 *               "full_name": "Gomez Selena",
 *               "face_token": "2|50e53c8977094db35169cae476009e80",
 *               "description": {
 *                   {
 *                       "0": -0.07384700328111649,
 *                       "1": 0.028888415545225143,
 *                       "2": -0.0480768084526062,
 *                       "3": -0.12844546139240265,
 *                       "4": -0.14265654981136322,
 *                       "5": -0.04318385198712349,
 *                       "6": -0.028748733922839165,
 *                       "7": -0.1121589168906212,
 *                       "8": 0.2790631055831909,
 *                       "9": -0.17422296106815338,
 *                       "10": 0.19744077324867249,
 *                       "11": 0.05546943098306656,
 *                       "12": -0.19182518124580383,
 *                       "13": -0.017534945160150528,
 *                       "14": -0.09439260512590408,
 *                       "15": 0.16562078893184662,
 *                       "16": -0.15283317863941193,
 *                       "17": -0.15842032432556152,
 *                       "18": -0.06623400747776031,
 *                       "19": -0.04042919725179672,
 *                       "20": 0.07783582806587219,
 *                       "21": -0.10033652931451796,
 *                       "22": 0.07874051481485367,
 *                       "23": 0.1966022551059723,
 *                       "24": -0.16036784648895264,
 *                       "25": -0.2958630621433258,
 *                       "26": -0.0567268468439579,
 *                       "27": -0.11080241948366164,
 *                       "28": -0.14833678305149078,
 *                       "29": -0.04755064100027085,
 *                       "30": 0.0799558088183403,
 *                       "31": 0.07829928398132324,
 *                       "32": -0.23776362836360931,
 *                       "33": -0.02827840112149715,
 *                       "34": -0.07042896747589111,
 *                       "35": 0.08977439999580383,
 *                       "36": -0.08310062438249588,
 *                       "37": -0.12288962304592133,
 *                       "38": 0.18477359414100647,
 *                       "39": 0.030138390138745308,
 *                       "40": -0.23363660275936127,
 *                       "41": -0.03899188339710235,
 *                       "42": 0.031014038249850273,
 *                       "43": 0.21635788679122925,
 *                       "44": 0.19000518321990967,
 *                       "45": -0.03674696385860443,
 *                       "46": 0.09226164221763612,
 *                       "47": -0.08655396103858948,
 *                       "48": 0.1653366982936859,
 *                       "49": -0.32252049446105957,
 *                       "50": 0.038111478090286255,
 *                       "51": 0.1265646517276764,
 *                       "52": 0.10350557416677476,
 *                       "53": 0.025416772812604904,
 *                       "54": 0.09597977995872498,
 *                       "55": -0.09067533910274506,
 *                       "56": 0.11579842865467072,
 *                       "57": 0.1772700995206833,
 *                       "58": -0.21377435326576233,
 *                       "59": -0.010202735662460327,
 *                       "60": 0.021680040284991264,
 *                       "61": -0.002149532549083233,
 *                       "62": -0.015626652166247368,
 *                       "63": -0.09406425803899764,
 *                       "64": 0.28820356726646423,
 *                       "65": 0.22779309749603271,
 *                       "66": -0.1292724907398224,
 *                       "67": -0.06183912232518196,
 *                       "68": 0.1565263271331787,
 *                       "69": -0.15003594756126404,
 *                       "70": -0.07642783224582672,
 *                       "71": 0.0930924192070961,
 *                       "72": -0.1581614762544632,
 *                       "73": -0.29889318346977234,
 *                       "74": -0.27784600853919983,
 *                       "75": 0.041987765580415726,
 *                       "76": 0.3784075081348419,
 *                       "77": 0.25018173456192017,
 *                       "78": -0.0515105240046978,
 *                       "79": 0.05259262770414352,
 *                       "80": -0.08110599219799042,
 *                       "81": 0.03981448709964752,
 *                       "82": -0.02799117937684059,
 *                       "83": 0.11209221184253693,
 *                       "84": -0.06427435576915741,
 *                       "85": 0.03835555166006088,
 *                       "86": -0.06437613070011139,
 *                       "87": 0.0959785059094429,
 *                       "88": 0.15402717888355255,
 *                       "89": -0.0020459932275116444,
 *                       "90": -0.053232014179229736,
 *                       "91": 0.285274475812912,
 *                       "92": -0.002381620928645134,
 *                       "93": -0.06673474609851837,
 *                       "94": -0.017091145738959312,
 *                       "95": 0.043505407869815826,
 *                       "96": -0.12424780428409576,
 *                       "97": 0.0720110535621643,
 *                       "98": -0.13692998886108398,
 *                       "99": 0.01661999523639679,
 *                       "100": 0.03311839699745178,
 *                       "101": 0.04575785622000694,
 *                       "102": 0.039326012134552,
 *                       "103": 0.019684087485074997,
 *                       "104": -0.17889255285263062,
 *                       "105": 0.053228963166475296,
 *                       "106": -0.13140828907489777,
 *                       "107": -0.052912384271621704,
 *                       "108": -0.04684467986226082,
 *                       "109": -0.03885597363114357,
 *                       "110": -0.1241067722439766,
 *                       "111": -0.03627171367406845,
 *                       "112": 0.06967753916978836,
 *                       "113": -0.22495655715465543,
 *                       "114": 0.15365582704544067,
 *                       "115": 0.09241408109664916,
 *                       "116": 0.04099966958165169,
 *                       "117": 0.16852715611457825,
 *                       "118": 0.06680759787559509,
 *                       "119": 0.040525853633880615,
 *                       "120": 0.0015581015031784773,
 *                       "121": -0.10148504376411438,
 *                       "122": -0.13842181861400604,
 *                       "123": 0.008927686139941216,
 *                       "124": 0.1297803819179535,
 *                       "125": -0.030984552577137947,
 *                       "126": 0.11469481885433196,
 *                       "127": -0.012583853676915169
 *                   },
 *                   {
 *                       "0": -0.07031845301389694,
 *                       "1": 0.018292557448148727,
 *                       "2": -0.03751157596707344,
 *                       "3": -0.10188204050064088,
 *                       "4": -0.104875385761261,
 *                       "5": -0.03773411363363266,
 *                       "6": 0.026081040501594543,
 *                       "7": -0.09816940128803252,
 *                       "8": 0.27022600173950195,
 *                       "9": -0.14588290452957153,
 *                       "10": 0.16495046019554138,
 *                       "11": 0.014340031892061234,
 *                       "12": -0.22820353507995603,
 *                       "13": 0.03203603997826576,
 *                       "14": -0.08628992736339569,
 *                       "15": 0.16988606750965118,
 *                       "16": -0.2249773144721985,
 *                       "17": -0.21731796860694885,
 *                       "18": -0.05789443850517273,
 *                       "19": -0.06329882144927979,
 *                       "20": 0.0649060532450676,
 *                       "21": -0.13289491832256317,
 *                       "22": 0.06518822908401489,
 *                       "23": 0.13481950759887695,
 *                       "24": -0.19685520231723783,
 *                       "25": -0.2718399465084076,
 *                       "26": -0.08124113827943802,
 *                       "27": -0.09937594085931778,
 *                       "28": -0.07623612880706787,
 *                       "29": -0.03441289812326431,
 *                       "30": 0.06816592812538147,
 *                       "31": 0.0844941958785057,
 *                       "32": -0.2451542615890503,
 *                       "33": -0.012073440477252008,
 *                       "34": -0.024034174159169197,
 *                       "35": 0.13594666123390198,
 *                       "36": -0.08010434359312057,
 *                       "37": -0.19143833220005035,
 *                       "38": 0.2181844562292099,
 *                       "39": 0.004158267751336098,
 *                       "40": -0.2139776349067688,
 *                       "41": -0.027627162635326385,
 *                       "42": 0.0331273153424263,
 *                       "43": 0.22210489213466644,
 *                       "44": 0.1642553210258484,
 *                       "45": -0.10990317165851592,
 *                       "46": 0.08109946548938751,
 *                       "47": -0.08405529707670212,
 *                       "48": 0.14125320315361023,
 *                       "49": -0.33876895904541016,
 *                       "50": 0.05713445320725441,
 *                       "51": 0.1472977101802826,
 *                       "52": 0.14057567715644836,
 *                       "53": 0.08454978466033936,
 *                       "54": 0.03754394128918648,
 *                       "55": -0.10511691868305206,
 *                       "56": 0.12370218336582184,
 *                       "57": 0.20312359929084775,
 *                       "58": -0.24583593010902405,
 *                       "59": -0.0016532414592802525,
 *                       "60": 0.06015641242265701,
 *                       "61": -0.030007749795913696,
 *                       "62": 0.006726999767124653,
 *                       "63": -0.058903053402900696,
 *                       "64": 0.22541067004203796,
 *                       "65": 0.2236916422843933,
 *                       "66": -0.12843641638755798,
 *                       "67": -0.13394305109977722,
 *                       "68": 0.14700745046138763,
 *                       "69": -0.1309247463941574,
 *                       "70": -0.023745473474264145,
 *                       "71": 0.11399248242378236,
 *                       "72": -0.14616763591766355,
 *                       "73": -0.31319209933280945,
 *                       "74": -0.2342500388622284,
 *                       "75": 0.06800814718008041,
 *                       "76": 0.41230735182762146,
 *                       "77": 0.2190646082162857,
 *                       "78": -0.03795204311609268,
 *                       "79": 0.06661683320999146,
 *                       "80": -0.11744268238544464,
 *                       "81": 0.014540055766701698,
 *                       "82": -0.019825931638479233,
 *                       "83": 0.08676324784755707,
 *                       "84": -0.06288298964500427,
 *                       "85": 0.041289620101451874,
 *                       "86": -0.12606200575828552,
 *                       "87": 0.12597984075546265,
 *                       "88": 0.1920213997364044,
 *                       "89": -0.04639188572764397,
 *                       "90": -0.10592105239629744,
 *                       "91": 0.21004638075828552,
 *                       "92": -0.0027237581089138985,
 *                       "93": -0.07164071500301361,
 *                       "94": 0.0003689862787723541,
 *                       "95": 0.06818310916423798,
 *                       "96": -0.10800864547491074,
 *                       "97": 0.08363436907529831,
 *                       "98": -0.1586027443408966,
 *                       "99": 0.007690086029469967,
 *                       "100": 0.007740995846688747,
 *                       "101": 0.024970587342977524,
 *                       "102": -0.018566207960247993,
 *                       "103": 0.01012004166841507,
 *                       "104": -0.12354519963264464,
 *                       "105": 0.05054318159818649,
 *                       "106": -0.08580810576677322,
 *                       "107": -0.09724511951208116,
 *                       "108": -0.09143905341625214,
 *                       "109": -0.08408564329147339,
 *                       "110": -0.14466135203838348,
 *                       "111": -0.022748492658138275,
 *                       "112": 0.08638308197259903,
 *                       "113": -0.2919594347476959,
 *                       "114": 0.150948628783226,
 *                       "115": 0.12510639429092407,
 *                       "116": 0.034765683114528656,
 *                       "117": 0.1879030466079712,
 *                       "118": 0.0607205368578434,
 *                       "119": 0.02445722185075283,
 *                       "120": 0.03736734017729759,
 *                       "121": -0.108883336186409,
 *                       "122": -0.13039109110832214,
 *                       "123": 0.009781088680028915,
 *                       "124": 0.1174745038151741,
 *                       "125": 0.05214357376098633,
 *                       "126": 0.09848155826330184,
 *                       "127": -0.010579974390566347
 *                   }
 *               }
 *           }
 *       }
 *   }
 *}
 * ),
 * @OA\Post(
 *     summary="Login a user (second step)",
 *     path="/api/login/face",
 *     description="Login a user",
 *     tags={"Auth"},
 *     @OA\RequestBody(
 *         required=true,
 *         description="pass user credentials",
 *         @OA\JsonContent(
 *             required={"email", "password"},
 *             @OA\Property(property="email", type="string", format="email", example="admin@admin.com"),
 *             @OA\Property(property="password", type="string", format="password", example="Password123"),
 *             @OA\Property(property="face_token", type="string", example="1|456c0e7f51991d54951aced6f14230eb"),
 *     ),
 * ),
 *     @OA\Response(
 *      response="200",
 *      description="User created successfully",
 *      @OA\JsonContent(
 *         @OA\Property(property="status", type="string", example="success"),
 *         @OA\Property(property="message", type="null", example="null"),
 *         @OA\Property(property="data", type="object",
 *              @OA\Property(property="token", type="string", example="CzU5Acl5F35dDLZkSJpgvUbPJJwPMZwnM0x2KSIo"),
 *         ),
 *      ),
 *     ),
 * ),
 * )
 * @OA\Post(
 *     summary="Login a user (first step)",
 *     path="/api/login",
 *     description="Login a user",
 *     tags={"Auth"},
 *     @OA\RequestBody(
 *         required=true,
 *         description="pass user credentials",
 *         @OA\JsonContent(
 *             required={"email", "password"},
 *             @OA\Property(property="email", type="string", format="email", example="admin@admin.com"),
 *             @OA\Property(property="password", type="string", format="password", example="Password123"),
 *     ),
 * ),
 *     @OA\Response(
 *      response="200",
 *      description="Successful operation",
 *      @OA\JsonContent(
 *     type="object",
 *     ref="#/components/schemas/FaceData"
 * ),
 *     @OA\Response(
 *      response="401",
 *      description="Credentials are not correct",
 *      @OA\JsonContent(
 *         @OA\Property(property="status", type="string", example="error"),
 *         @OA\Property(property="message", type="string", example="Credentials not match"),
 *         @OA\Property(property="data", type="string", example="null"),
 *         ),
 *      ),
 *     @OA\Response(
 *      response="422",
 *      description="The given data was invalid",
 *      @OA\JsonContent(
 *         @OA\Property(property="message", type="string", example="The given data was invalid."),
 *         @OA\Property(property="errors", type="object",
 *              @OA\Property(property="email", type="array",
 *                 @OA\Items(type="string", example="The email has already been taken.")),
 *              @OA\Property(property="password", type="array",
 *                 @OA\Items(type="string", example="The password must be at least 6 characters.")),
 *         ),
 *      ),
 *     ),
 * ),
 * )
 */
class LoginController extends BaseController
{
    use ApiResponser;

    public function sendFaceData(Request $request)
    {
        $attr = $request->validate([
            'email' => 'required|string|email',
            'password' => 'required|string|min:6'
        ]);

        if (!Auth::guard('api')->attempt($attr)) {
            return $this->error('Credentials not match', 401);
        }

        $user = Auth::guard('api')->user();

        return $this->success((new FaceData())->getFaceModels($user->id), 'Retrieved successfully');
    }

    public function authenticate(Request $request)
    {
        $attr = $request->validate([
            'email' => 'required|string|email',
            'password' => 'required|string|min:6',
            'face_token' => 'required|string',
        ]);

        if (!Auth::guard('api')->attempt([
            'email' => $attr['email'],
            'password' => $attr['password'],
        ])) {
            return $this->error('Credentials not match', 401);
        }

        if (!(new FaceData())->validateFaceToken(Auth::guard('api')->user()->id, $attr['face_token'])) {
            return $this->error('Face token is not valid.', 422);
        }

        auth('api')->user()->update(['last_login' => Carbon::now()->toDateTimeString()]);
        return $this->success([
            'token' => auth('api')->user()->createToken('API Token')->plainTextToken
        ]);
    }
}
